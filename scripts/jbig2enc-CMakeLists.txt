# CMakeLists.txt for building jbig2enc as a static library on Windows.
# This file is copied into the jbig2enc source tree by setup-windows.ps1.
#
# jbig2enc upstream uses autotools, which does not support Windows natively.
# This CMake build compiles only the library (not the CLI tool).

cmake_minimum_required(VERSION 3.20)
project(jbig2enc LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# --- Find leptonica headers (required for PIX type) ---
# CMAKE_PREFIX_PATH should point to the vcpkg installed directory.
find_path(LEPTONICA_INCLUDE_DIR
    NAMES leptonica/allheaders.h
    HINTS
        ${LEPTONICA_INCLUDE_DIR}
        ${CMAKE_PREFIX_PATH}/include
)

if(NOT LEPTONICA_INCLUDE_DIR)
    message(FATAL_ERROR "leptonica headers not found. Set CMAKE_PREFIX_PATH to vcpkg installed dir.")
endif()

message(STATUS "leptonica include: ${LEPTONICA_INCLUDE_DIR}")

# --- Generate minimal config.h (normally created by autotools ./configure) ---
file(WRITE "${CMAKE_BINARY_DIR}/config.h" "/* Generated by CMake for Windows build */\n")

# --- Collect source files ---
# jbig2enc.cc contains jbig2_encode_generic (the function we need).
# jbig2arith.cc provides the arithmetic encoder used by jbig2enc.cc.
set(JBIG2ENC_SOURCES
    jbig2enc.cc
    jbig2arith.cc
)

# Include optional source files if they exist.
foreach(optional_src jbig2sym.cc jbig2comparator.cc)
    if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/${optional_src}")
        list(APPEND JBIG2ENC_SOURCES ${optional_src})
    endif()
endforeach()

# --- Build static library ---
add_library(jbig2enc STATIC ${JBIG2ENC_SOURCES})

target_include_directories(jbig2enc
    PUBLIC  ${CMAKE_CURRENT_SOURCE_DIR}
    PRIVATE ${CMAKE_BINARY_DIR}          # config.h
    PRIVATE ${LEPTONICA_INCLUDE_DIR}
)

# MSVC: suppress warnings from third-party code
if(MSVC)
    target_compile_options(jbig2enc PRIVATE /W3 /wd4244 /wd4267 /wd4996)
endif()

# --- Install ---
install(TARGETS jbig2enc ARCHIVE DESTINATION lib)

file(GLOB JBIG2ENC_HEADERS "${CMAKE_CURRENT_SOURCE_DIR}/*.h")
install(FILES ${JBIG2ENC_HEADERS} DESTINATION include)
